<html><head><link href="stylesheets/documentation.css" rel="stylesheet" title="documentation" type="text/css" /> <title>documentation</title></head><body bgcolor="#ffecd9" text="#000000" link="#000000" vlink="#000000"><a name="START"></a><h1><font color="#0000ff">CGI Programming with LAML</font></h1><h3><span>Kurt N&#248;rmark   &copy;</span> &nbsp; &nbsp; normark@cs.aau.dk <br /> Department of Computer Science, Aalborg University</h3><p></p><div class="elucidator-abstract"><b>Abstract.</b> <p>In this chapter we give an example of a CGI program written in Scheme using the LAML cgi library.</p></div><div>&nbsp; <p></p></div><div class="elucidator-section"><a name="intro"></a><div><a href="documentation.html#START"><img src="./images/small-up.gif" title="" alt="" border="0" /></a> <img src="./images/small-prev-blind.gif" title="" alt="" border="0" /> <a href="documentation.html#design-sect"><img src="./images/small-next.gif" title="Overall design" alt="" border="0" /></a></div><div><b><font size="5"><span>1 &nbsp; &nbsp; Introduction</span></font></b></div><div class="body-normal">We are going to develop a simple number guessing game.</div><div style="margin-left:10px;"><font size="2"><span>1.1 &nbsp; &nbsp; <a href="documentation.html#the-game" target="documentation-frame"><font color="#000000">The game</font></a></span></font> <br /></div></div><div>&nbsp; <p></p></div><div class="elucidator-entry"><a name="the-game"></a><div class="elucidator-entry-head"><a href="documentation.html#intro"><img src="./images/small-up.gif" title="Introduction" alt="" border="0" /></a> <img src="./images/small-prev-blind.gif" title="" alt="" border="0" /> <img src="./images/small-next-blind.gif" title="" alt="" border="0" />  <br /> <b><font size="4"><span>1.1 &nbsp; &nbsp; The game</span></font></b></div><div class="body-normal">The game is very simple, and it is a common demonstration of a www server side program. The machine picks a secret number between 0 and 100 which you are supposed to guess. Upon each guess, the machine will tell you if your guess is too low, too high, or correct. The machine part is running on an Appache WEB server on a Unix machine.  <p></p> The game is operational, and it can be played from  <a href="http://www.cs.auc.dk/~normark/cgi-bin/number-guess/number-guess.cgi" target="game">here</a>  if you are connected to the Internet.  <p></p> The pure Scheme program is available via  <a href="../../../examples/tutorial/cgi-programming/index.html" target="program-frame" title="LAML example"><font color="#000000">the tutorial example page</font></a> .</div></div><div class="elucidator-section"><a name="design-sect"></a><div><a href="documentation.html#START"><img src="./images/small-up.gif" title="" alt="" border="0" /></a> <a href="documentation.html#intro"><img src="./images/small-prev.gif" title="Introduction" alt="" border="0" /></a> <a href="documentation.html#the-program-part"><img src="./images/small-next.gif" title="The program" alt="" border="0" /></a></div><div><b><font size="5"><span>2 &nbsp; &nbsp; Overall design</span></font></b></div><div class="body-normal">Although this program is simple and small we have used a structure which, in some respects at least, can be used for larger and more realistic CGI programs.</div><div style="margin-left:10px;"><font size="2"><span>2.1 &nbsp; &nbsp; <a href="documentation.html#design" target="documentation-frame"><font color="#000000">The overall design</font></a></span></font> <br /></div></div><div>&nbsp; <p></p></div><div class="elucidator-entry"><a name="design"></a><div class="elucidator-entry-head"><a href="documentation.html#design-sect"><img src="./images/small-up.gif" title="Overall design" alt="" border="0" /></a> <img src="./images/small-prev-blind.gif" title="" alt="" border="0" /> <img src="./images/small-next-blind.gif" title="" alt="" border="0" />  <br /> <b><font size="4"><span>2.1 &nbsp; &nbsp; The overall design</span></font></b></div><div class="body-normal">We decide to split the program in a tiny CGI shell and the Scheme program as such. The CGI shell, which must be located in the  <span class="none-reference">.public_html/cgi-bin</span>  directory, is here: <blockquote><pre style="font-size:11px;">
#!/bin/sh
 
string=? ; exec /pack/mzscheme/bin/mzscheme \-r \$0 &quot;\$\@&quot;

;; This program implements a number guessing game, 
;; which is commonly used to illustrate simple WWW
;; server programming.

(define example-tutorial-dir &quot;/user/normark/scheme/examples/tutorial/&quot;)
(load (string-append example-tutorial-dir 
         &quot;cgi-programming/number-guess.scm&quot;))
</pre></blockquote> The name of the file must be  <span class="none-reference">number-guess.cgi</span> , and it should be file protected to be executable (typically with  <kbd>chmod 755</kbd> ). <p></p> This starts MzScheme via a shell script, and the load line is executed. It would be perfectly possible to place the entire Scheme program here, but we prefer in general to organize our software in a directory outside the .public_html catalogue. Therefore we load the number guessing program from the tutorial example directory in my LAML development directory, which happens to be  <span class="none-reference">/normark/scheme</span> . <p></p> As another important point, we decide to organize the number guessing system as a single program, which in the  <a class="program-reference-strong" href="number-guess-1-LARGE.html#page-write" target="program-frame" title="number-guess">page-write</a>  part branches between a game init part ( <span><a href="number-guess-1-LARGE.html#page-write-@b" target="program-frame"><img src="./images/source-mark-green.gif" title="A link to a program source marker in page-write" alt="" border="0" /></a><a name="design-@b"></a></span> ) and a game playing part ( <span><a href="number-guess-1-LARGE.html#page-write-@a" target="program-frame"><img src="./images/source-mark-red.gif" title="A link to a program source marker in page-write" alt="" border="0" /></a><a name="design-@a"></a></span> ). We could as well have written two separate CGI programs, which probably would have been preferable in case the &#39;System&#39; is larger. Such an alternative organization would typically call for common definitions organized in a shared scheme number guessing libary file.</div></div><div class="elucidator-section"><a name="the-program-part"></a><div><a href="documentation.html#START"><img src="./images/small-up.gif" title="" alt="" border="0" /></a> <a href="documentation.html#design-sect"><img src="./images/small-prev.gif" title="Overall design" alt="" border="0" /></a> <img src="./images/small-next-blind.gif" title="" alt="" border="0" /></div><div><b><font size="5"><span>3 &nbsp; &nbsp; The program</span></font></b></div><div class="body-normal">In this section we describe the number guessing program details.</div><div style="margin-left:10px;"><font size="2"><span>3.1 &nbsp; &nbsp; <a href="documentation.html#preamble-part" target="documentation-frame"><font color="#000000">The preamble part</font></a></span></font> <br /> <font size="2"><span>3.2 &nbsp; &nbsp; <a href="documentation.html#init-game" target="documentation-frame"><font color="#000000">The init game part</font></a></span></font> <br /> <font size="2"><span>3.3 &nbsp; &nbsp; <a href="documentation.html#game-part" target="documentation-frame"><font color="#000000">The game part</font></a></span></font> <br /></div></div><div>&nbsp; <p></p></div><div class="elucidator-entry"><a name="preamble-part"></a><div class="elucidator-entry-head"><a href="documentation.html#the-program-part"><img src="./images/small-up.gif" title="The program" alt="" border="0" /></a> <img src="./images/small-prev-blind.gif" title="" alt="" border="0" /> <a href="documentation.html#init-game"><img src="./images/small-next.gif" title="The init game part" alt="" border="0" /></a>  <br /> <b><font size="4"><span>3.1 &nbsp; &nbsp; The preamble part</span></font></b></div><div class="body-normal">We will here comment on the preamble part of the number guessing program. It follows the typical pattern of most Scheme CGI programs we have written. <p></p> The first thing to do in the section  <a class="program-reference-strong" href="number-guess-1-LARGE.html#laml-loading" target="program-frame" title="number-guess">laml-loading</a>  is to load  <kbd>laml.scm</kbd> .In order to do so we must set  <a class="program-reference-strong" href="number-guess-1-LARGE.html#laml-dir" target="program-frame" title="number-guess">laml-dir</a>  ( <span><a href="number-guess-1-LARGE.html#laml-dir-@g" target="program-frame"><img src="./images/source-mark-purple.gif" title="A link to a program source marker in laml-dir" alt="" border="0" /></a><a name="preamble-part-@g"></a></span> ).  <a class="program-reference-strong" href="number-guess-1-LARGE.html#laml-dir" target="program-frame" title="number-guess">laml-dir</a>  is important, because it&#39;s value points at the root of the LAML system, which is used. Being at  <span class="none-reference">cs.auc.dk</span>  it is natural to use the shared LAML system in  <span class="none-reference">/pack/laml/</span> . Alternatively, the directory address of your own LAML system can be used. <p></p> Next comes the section  <a class="program-reference-strong" href="number-guess-1-LARGE.html#initial-constants" target="program-frame" title="number-guess">initial-constants</a> . The variable  <a class="program-reference-strong" href="number-guess-1-LARGE.html#number-guess-url-prefix" target="program-frame" title="number-guess">number-guess-url-prefix</a>  and not least the derived function  <a class="program-reference-strong" href="number-guess-1-LARGE.html#number-guess-url" target="program-frame" title="number-guess">number-guess-url</a>  are used to address the number guessing program from a browser. The function returns an URL with actual URL parameters - following the question mark. The function  <a class="manual-reference" href="../../../lib/man/cgi.html#make-url-parameters" target="program-frame" title="Manual: cgi">make-url-parameters</a>  is from the cgi LAML library, and it makes a list of actual URL parameters. We will meet the function  <a class="program-reference-strong" href="number-guess-1-LARGE.html#number-guess-url" target="program-frame" title="number-guess">number-guess-url</a>  later on. <p></p> Next comes the  <a class="program-reference-strong" href="number-guess-1-LARGE.html#additional-loading" target="program-frame" title="number-guess">additional-loading</a>  part of the program. Here the  <a href="../../../lib/man/cgi.html#cgi library" target="laml-manual-page" title="LAML manual" style="{text-decoration: none;}"><font color="#005a00">cgi library</font></a>  is loaded by means of the  <span class="none-reference">lib-load</span>  procedure, and a number of other libraries are loaded too. The  <a href="../../../lib/man/encode-decode.html#encode-decode" target="laml-manual-page" title="LAML manual" style="{text-decoration: none;}"><font color="#005a00">encode-decode</font></a>  library ( <span><a href="number-guess-1-LARGE.html#additional-loading-@b" target="program-frame"><img src="./images/source-mark-green.gif" title="A link to a program source marker in additional-loading" alt="" border="0" /></a><a name="preamble-part-@b"></a></span> ) is used by  <span class="none-reference">cgi.scm</span>  for encoding and decoding URL parameters. <p></p> In  <a class="program-reference-strong" href="number-guess-1-LARGE.html#other-settings" target="program-frame" title="number-guess">other-settings</a>  we set the variable  <a class="program-reference-strong" href="number-guess-1-LARGE.html#cgi-testing" target="program-frame" title="number-guess">cgi-testing</a>  to #f and we register the current time in  <a class="program-reference-strong" href="number-guess-1-LARGE.html#cur-time" target="program-frame" title="number-guess">cur-time</a> . The time is not used in this program, but it general this number is useful for a variety of purposes (such as making file names &#39;unique&#39;). <p></p> In the section  <a class="program-reference-strong" href="number-guess-1-LARGE.html#url-parameters" target="program-frame" title="number-guess">url-parameters</a>  we extract the URL parameters passed to the program. The variable  <a class="program-reference-strong" href="number-guess-1-LARGE.html#language-preference" target="program-frame" title="number-guess">language-preference</a>  controls whether the Danish or English language is used in the game, with english as the default. The function  <span class="none-reference">text-choice</span>  uses the variable  <a class="program-reference-strong" href="number-guess-1-LARGE.html#language-preference" target="program-frame" title="number-guess">language-preference</a> . The variable  <a class="program-reference-strong" href="number-guess-1-LARGE.html#mode" target="program-frame" title="number-guess">mode</a>  is important because it controls the part of the program to be started; Possible values are the symbols  <span class="none-reference">init</span>  or  <span class="none-reference">play</span> , with  <span class="none-reference">init</span>  as the default. The function  <span class="none-reference">defaulted-get</span>  is a function from the LAML general library. <p></p> The CGI library function  <a href="../../../lib/man/cgi.html#extract-url-parameters" target="laml-manual-page" title="LAML manual" style="{text-decoration: none;}"><font color="#005a00">extract-url-parameters</font></a>   decodes the URL parameters. The variable  <a class="program-reference-strong" href="number-guess-1-LARGE.html#url-pars" target="program-frame" title="number-guess">url-pars</a>  is an association list (a list of cons pairs), such as <blockquote><pre style="font-size:11px;">
  ((language . &quot;english&quot;) (mode . &quot;init&quot;))</pre></blockquote> This ends the game preamble part.</div></div><div class="elucidator-entry"><a name="init-game"></a><div class="elucidator-entry-head"><a href="documentation.html#the-program-part"><img src="./images/small-up.gif" title="The program" alt="" border="0" /></a> <a href="documentation.html#preamble-part"><img src="./images/small-prev.gif" title="The preamble part" alt="" border="0" /></a> <a href="documentation.html#game-part"><img src="./images/small-next.gif" title="The game part" alt="" border="0" /></a>  <br /> <b><font size="4"><span>3.2 &nbsp; &nbsp; The init game part</span></font></b></div><div class="body-normal">The function  <a class="program-reference-strong" href="number-guess-1-LARGE.html#game-init" target="program-frame" title="number-guess">game-init</a>  returns a HTML body to be used in one of the branches of the  <a class="program-reference-weak" href="number-guess-1-LARGE.html#page-write" target="program-frame" title="number-guess">page-write</a>  section in the program. This is the place to draw the secret number ( <span><a href="number-guess-1-LARGE.html#game-init-@a" target="program-frame"><img src="./images/source-mark-red.gif" title="A link to a program source marker in game-init" alt="" border="0" /></a><a name="init-game-@a"></a></span> ). <p></p> Also notice the form element, generated by  <a href="../../../lib/html4.01-transitional-validating/man/convenience.html#form-1" target="laml-manual-page" title="LAML manual" style="{text-decoration: none;}"><font color="#005a00">form-1</font></a>  at ( <span><a href="number-guess-1-LARGE.html#game-init-@b" target="program-frame"><img src="./images/source-mark-green.gif" title="A link to a program source marker in game-init" alt="" border="0" /></a><a name="init-game-@b"></a></span> ). This determines the program which will receive form input when submitted. Thus, when we submit a new guess this detail determines the receiving CGI program. Here, we reuse the same program for this purpose (due the outer branching discussed above), but notice that we switch to  <span class="none-reference">play</span>  mode. We pass the  <span class="none-reference">language-preference</span>  as the language URL parameter. <p></p> After a welcome text we call  <a class="program-reference-weak" href="number-guess-1-LARGE.html#guess-part" target="program-frame" title="number-guess">guess-part</a>  ( <span><a href="number-guess-1-LARGE.html#game-init-@c" target="program-frame"><img src="./images/source-mark-blue.gif" title="A link to a program source marker in game-init" alt="" border="0" /></a><a name="init-game-@c"></a></span> ), which renders the form used for the user&#39;s guess. <p></p> Let us now look at  <a class="program-reference-strong" href="number-guess-1-LARGE.html#guess-part" target="program-frame" title="number-guess">guess-part</a> , which returns part of the body. Most functions called by  <a class="program-reference-strong" href="number-guess-1-LARGE.html#guess-part" target="program-frame" title="number-guess">guess-part</a>  are so-called convenience functions, made on top of the HTML mirror libraries. The function  <span class="none-reference">text-line</span>  renders an input field, in which the guess can be entered ( <span><a href="number-guess-1-LARGE.html#guess-part-@f" target="program-frame"><img src="./images/source-mark-grey.gif" title="A link to a program source marker in guess-part" alt="" border="0" /></a><a name="init-game-@f"></a></span> ). The secret number is passed on using a hidden field ( <span><a href="number-guess-1-LARGE.html#guess-part-@g" target="program-frame"><img src="./images/source-mark-purple.gif" title="A link to a program source marker in guess-part" alt="" border="0" /></a><a name="init-game-@g"></a></span> ). In a better version of the program we should protect this field from being read directly in the document source. The submit button is also made in this function ( <span><a href="number-guess-1-LARGE.html#guess-part-@h" target="program-frame"><img src="./images/source-mark-silver.gif" title="A link to a program source marker in guess-part" alt="" border="0" /></a><a name="init-game-@h"></a></span> ).</div></div><div class="elucidator-entry"><a name="game-part"></a><div class="elucidator-entry-head"><a href="documentation.html#the-program-part"><img src="./images/small-up.gif" title="The program" alt="" border="0" /></a> <a href="documentation.html#init-game"><img src="./images/small-prev.gif" title="The init game part" alt="" border="0" /></a> <img src="./images/small-next-blind.gif" title="" alt="" border="0" />  <br /> <b><font size="4"><span>3.3 &nbsp; &nbsp; The game part</span></font></b></div><div class="body-normal">The game part, represented by  <a class="program-reference-strong" href="number-guess-1-LARGE.html#game-play" target="program-frame" title="number-guess">game-play</a> , is the place where we get a hint about our guess, and we are allowed to make a new guess if we did not hit the number exactly. We first have to extract the submitted form input. This is done by the CGI library  <span class="none-reference">extract-form-input</span>  from the CGI library ( <span><a href="number-guess-1-LARGE.html#game-play-@i" target="program-frame"><img src="./images/source-mark-tetal.gif" title="A link to a program source marker in game-play" alt="" border="0" /></a><a name="game-part-@i"></a></span> ), which returns an association list such as <pre>((secret-number . &quot;42&quot;) (players-guess . &quot;22&quot;))</pre> We prepare a body with a new form element (as above) ( <span><a href="number-guess-1-LARGE.html#game-play-@j" target="program-frame"><img src="./images/source-mark-aqua.gif" title="A link to a program source marker in game-play" alt="" border="0" /></a><a name="game-part-@j"></a></span> ). The conditional ( <span><a href="number-guess-1-LARGE.html#game-play-@k" target="program-frame"><img src="./images/source-mark-lime.gif" title="A link to a program source marker in game-play" alt="" border="0" /></a><a name="game-part-@k"></a></span> ) compares the secret number with the players guess, and an appropriate hint is presented. Notice how  <a class="program-reference-weak" href="number-guess-1-LARGE.html#guess-part" target="program-frame" title="number-guess">guess-part</a>  is activated if no exact hit is found ( <span><a href="number-guess-1-LARGE.html#game-play-@c" target="program-frame"><img src="./images/source-mark-blue.gif" title="A link to a program source marker in game-play" alt="" border="0" /></a><a name="game-part-@c"></a></span>   <span><a href="number-guess-1-LARGE.html#game-play-@d" target="program-frame"><img src="./images/source-mark-black.gif" title="A link to a program source marker in game-play" alt="" border="0" /></a><a name="game-part-@d"></a></span> ). In the lucky case where the player guesses the number an URL is given to restart the game ( <span><a href="number-guess-1-LARGE.html#game-play-@e" target="program-frame"><img src="./images/source-mark-maroon.gif" title="A link to a program source marker in game-play" alt="" border="0" /></a><a name="game-part-@e"></a></span> ).</div></div><div>&nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p> &nbsp; <p></p></div></body></html>